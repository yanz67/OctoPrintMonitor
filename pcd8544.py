"""
MicroPython Nokia 5110 PCD8544 84x48 LCD driver
https://github.com/mcauser/micropython-pcd8544

MIT License
Copyright (c) 2016-2018 Mike Causer

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
"""

from micropython import const
from ustruct import pack
from utime import sleep_us
import framebuf

# Font ported from
# https://github.com/SlimTim10/PCD8544/blob/master/font.c
FONT = [
    [0x00, 0x00, 0x00, 0x00, 0x00],  # /* 0x20	  */
    [0x00, 0x00, 0x5f, 0x00, 0x00],  # /* 0x21	! */
    [0x00, 0x07, 0x00, 0x07, 0x00],  # /* 0x22	" */
    [0x14, 0x7f, 0x14, 0x7f, 0x14],  # /* 0x23	# */
    [0x24, 0x2a, 0x7f, 0x2a, 0x12],  # /* 0x24	$ */
    [0x23, 0x13, 0x08, 0x64, 0x62],  # /* 0x25	% */
    [0x36, 0x49, 0x55, 0x22, 0x50],  # /* 0x26	& */
    [0x00, 0x05, 0x03, 0x00, 0x00],  # /* 0x27	' */
    [0x00, 0x1c, 0x22, 0x41, 0x00],  # /* 0x28	( */
    [0x00, 0x41, 0x22, 0x1c, 0x00],  # /* 0x29	) */
    [0x14, 0x08, 0x3e, 0x08, 0x14],  # /* 0x2a	* */
    [0x08, 0x08, 0x3e, 0x08, 0x08],  # /* 0x2b	+ */
    [0x00, 0x50, 0x30, 0x00, 0x00],  # /* 0x2c	, */
    [0x08, 0x08, 0x08, 0x08, 0x08],  # /* 0x2d	- */
    [0x00, 0x60, 0x60, 0x00, 0x00],  # /* 0x2e	. */
    [0x20, 0x10, 0x08, 0x04, 0x02],  # /* 0x2f	/ */
    [0x3e, 0x51, 0x49, 0x45, 0x3e],  # /* 0x30	0 */
    [0x00, 0x42, 0x7f, 0x40, 0x00],  # /* 0x31	1 */
    [0x42, 0x61, 0x51, 0x49, 0x46],  # /* 0x32	2 */
    [0x21, 0x41, 0x45, 0x4b, 0x31],  # /* 0x33	3 */
    [0x18, 0x14, 0x12, 0x7f, 0x10],  # /* 0x34	4 */
    [0x27, 0x45, 0x45, 0x45, 0x39],  # /* 0x35	5 */
    [0x3c, 0x4a, 0x49, 0x49, 0x30],  # /* 0x36	6 */
    [0x01, 0x71, 0x09, 0x05, 0x03],  # /* 0x37	7 */
    [0x36, 0x49, 0x49, 0x49, 0x36],  # /* 0x38	8 */
    [0x06, 0x49, 0x49, 0x29, 0x1e],  # /* 0x39	9 */
    [0x00, 0x36, 0x36, 0x00, 0x00],  # /* 0x3a	: */
    [0x00, 0x56, 0x36, 0x00, 0x00],  # /* 0x3b	; */
    [0x08, 0x14, 0x22, 0x41, 0x00],  # /* 0x3c	< */
    [0x14, 0x14, 0x14, 0x14, 0x14],  # /* 0x3d	= */
    [0x00, 0x41, 0x22, 0x14, 0x08],  # /* 0x3e	> */
    [0x02, 0x01, 0x51, 0x09, 0x06],  # /* 0x3f	? */
    [0x32, 0x49, 0x79, 0x41, 0x3e],  # /* 0x40	@ */
    [0x7e, 0x11, 0x11, 0x11, 0x7e],  # /* 0x41	A */
    [0x7f, 0x49, 0x49, 0x49, 0x36],  # /* 0x42	B */
    [0x3e, 0x41, 0x41, 0x41, 0x22],  # /* 0x43	C */
    [0x7f, 0x41, 0x41, 0x22, 0x1c],  # /* 0x44	D */
    [0x7f, 0x49, 0x49, 0x49, 0x41],  # /* 0x45	E */
    [0x7f, 0x09, 0x09, 0x09, 0x01],  # /* 0x46	F */
    [0x3e, 0x41, 0x49, 0x49, 0x7a],  # /* 0x47	G */
    [0x7f, 0x08, 0x08, 0x08, 0x7f],  # /* 0x48	H */
    [0x00, 0x41, 0x7f, 0x41, 0x00],  # /* 0x49	I */
    [0x20, 0x40, 0x41, 0x3f, 0x01],  # /* 0x4a	J */
    [0x7f, 0x08, 0x14, 0x22, 0x41],  # /* 0x4b	K */
    [0x7f, 0x40, 0x40, 0x40, 0x40],  # /* 0x4c	L */
    [0x7f, 0x02, 0x0c, 0x02, 0x7f],  # /* 0x4d	M */
    [0x7f, 0x04, 0x08, 0x10, 0x7f],  # /* 0x4e	N */
    [0x3e, 0x41, 0x41, 0x41, 0x3e],  # /* 0x4f	O */
    [0x7f, 0x09, 0x09, 0x09, 0x06],  # /* 0x50	P */
    [0x3e, 0x41, 0x51, 0x21, 0x5e],  # /* 0x51	Q */
    [0x7f, 0x09, 0x19, 0x29, 0x46],  # /* 0x52	R */
    [0x46, 0x49, 0x49, 0x49, 0x31],  # /* 0x53	S */
    [0x01, 0x01, 0x7f, 0x01, 0x01],  # /* 0x54	T */
    [0x3f, 0x40, 0x40, 0x40, 0x3f],  # /* 0x55	U */
    [0x1f, 0x20, 0x40, 0x20, 0x1f],  # /* 0x56	V */
    [0x3f, 0x40, 0x38, 0x40, 0x3f],  # /* 0x57	W */
    [0x63, 0x14, 0x08, 0x14, 0x63],  # /* 0x58	X */
    [0x07, 0x08, 0x70, 0x08, 0x07],  # /* 0x59	Y */
    [0x61, 0x51, 0x49, 0x45, 0x43],  # /* 0x5a	Z */
    [0x00, 0x7f, 0x41, 0x41, 0x00],  # /* 0x5b	[ */
    [0x02, 0x04, 0x08, 0x10, 0x20],  # /* 0x5c	yuan symbol */
    [0x00, 0x41, 0x41, 0x7f, 0x00],  # /* 0x5d	] */
    [0x04, 0x02, 0x01, 0x02, 0x04],  # /* 0x5e	^ */
    [0x40, 0x40, 0x40, 0x40, 0x40],  # /* 0x5f	_ */
    [0x00, 0x01, 0x02, 0x04, 0x00],  # /* 0x60	` */
    [0x20, 0x54, 0x54, 0x54, 0x78],  # /* 0x61	a */
    [0x7f, 0x48, 0x44, 0x44, 0x38],  # /* 0x62	b */
    [0x38, 0x44, 0x44, 0x44, 0x20],  # /* 0x63	c */
    [0x38, 0x44, 0x44, 0x48, 0x7f],  # /* 0x64	d */
    [0x38, 0x54, 0x54, 0x54, 0x18],  # /* 0x65	e */
    [0x08, 0x7e, 0x09, 0x01, 0x02],  # /* 0x66	f */
    [0x0c, 0x52, 0x52, 0x52, 0x3e],  # /* 0x67	g */
    [0x7f, 0x08, 0x04, 0x04, 0x78],  # /* 0x68	h */
    [0x00, 0x44, 0x7d, 0x40, 0x00],  # /* 0x69	i */
    [0x20, 0x40, 0x44, 0x3d, 0x00],  # /* 0x6a	j  */
    [0x7f, 0x10, 0x28, 0x44, 0x00],  # /* 0x6b	k */
    [0x00, 0x41, 0x7f, 0x40, 0x00],  # /* 0x6c	l */
    [0x7c, 0x04, 0x18, 0x04, 0x78],  # /* 0x6d	m */
    [0x7c, 0x08, 0x04, 0x04, 0x78],  # /* 0x6e	n */
    [0x38, 0x44, 0x44, 0x44, 0x38],  # /* 0x6f	o */
    [0x7c, 0x14, 0x14, 0x14, 0x08],  # /* 0x70	p */
    [0x08, 0x14, 0x14, 0x18, 0x7c],  # /* 0x71	q */
    [0x7c, 0x08, 0x04, 0x04, 0x08],  # /* 0x72	r */
    [0x48, 0x54, 0x54, 0x54, 0x20],  # /* 0x73	s */
    [0x04, 0x3f, 0x44, 0x40, 0x20],  # /* 0x74	t */
    [0x3c, 0x40, 0x40, 0x20, 0x7c],  # /* 0x75	u */
    [0x1c, 0x20, 0x40, 0x20, 0x1c],  # /* 0x76	v */
    [0x3c, 0x40, 0x30, 0x40, 0x3c],  # /* 0x77	w */
    [0x44, 0x28, 0x10, 0x28, 0x44],  # /* 0x78	x */
    [0x0c, 0x50, 0x50, 0x50, 0x3c],  # /* 0x79	y */
    [0x44, 0x64, 0x54, 0x4c, 0x44],  # /* 0x7a	z */
    [0x00, 0x08, 0x36, 0x41, 0x00],  # /* 0x7b	[ */
    [0x00, 0x00, 0x7f, 0x00, 0x00],  # /* 0x7c	| */
    [0x00, 0x41, 0x36, 0x08, 0x00],  # /* 0x7d	} */
    [0x10, 0x08, 0x08, 0x10, 0x08],  # /* 0x7e	left arrow */
    [0x78, 0x46, 0x41, 0x46, 0x78],  # /* 0x7f	right arrow */
]
FONT_CHAR_OFFSET = 32

# Function set 0010 0xxx
FUNCTION_SET = const(0x20)
POWER_DOWN = const(0x04)
ADDRESSING_VERT = const(0x02)
EXTENDED_INSTR = const(0x01)

# Display control 0000 1x0x
DISPLAY_BLANK = const(0x08)
DISPLAY_ALL = const(0x09)
DISPLAY_NORMAL = const(0x0c)
DISPLAY_INVERSE = const(0x0d)

# Temperature control 0000 01xx
TEMP_COEFF_0 = const(0x04)
TEMP_COEFF_1 = const(0x05)
TEMP_COEFF_2 = const(0x06)  # default
TEMP_COEFF_3 = const(0x07)

# Bias system 0001 0xxx
BIAS_1_100 = const(0x10)
BIAS_1_80 = const(0x11)
BIAS_1_65 = const(0x12)
BIAS_1_48 = const(0x13)
BIAS_1_40 = const(0x14)  # default
BIAS_1_24 = const(0x15)
BIAS_1_18 = const(0x16)
BIAS_1_10 = const(0x17)

# Set operation voltage
SET_VOP = const(0x80)

# DDRAM addresses
COL_ADDR = const(0x80)  # x pos (0~83)
BANK_ADDR = const(0x40)  # y pos, in banks of 8 rows (0~5)

# Display dimensions
WIDTH = const(0x54)  # 84
HEIGHT = const(0x30)  # 48


class PCD8544:
    def __init__(self, spi, cs, dc, rst=None):
        self.spi = spi
        self.cs = cs  # chip enable, active LOW
        self.dc = dc  # data HIGH, command LOW
        self.rst = rst  # reset, active LOW

        self.height = HEIGHT  # For Writer class
        self.width = WIDTH

        self.cs.init(self.cs.OUT, value=1)
        self.dc.init(self.dc.OUT, value=0)

        if self.rst:
            self.rst.init(self.rst.OUT, value=1)
        self.reset()
        self.init()

    def init(self, horizontal=True, contrast=0x3f, bias=BIAS_1_40, temp=TEMP_COEFF_2):
        # power up, horizontal addressing, basic instruction set
        self.fn = FUNCTION_SET
        self.addressing(horizontal)
        self.contrast(contrast, bias, temp)
        self.cmd(DISPLAY_NORMAL)
        self.clear()

    def reset(self):
        # issue reset impulse to reset the display
        # you need to call power_on() or init() to resume
        self.rst(1)
        sleep_us(100)
        self.rst(0)
        sleep_us(100)  # reset impulse has to be >100 ns and <100 ms
        self.rst(1)
        sleep_us(100)

    def power_on(self):
        self.cs(1)
        self.fn &= ~POWER_DOWN
        self.cmd(self.fn)

    def power_off(self):
        self.fn |= POWER_DOWN
        self.cmd(self.fn)

    def contrast(self, contrast=0x3f, bias=BIAS_1_40, temp=TEMP_COEFF_2):
        for cmd in (
                # extended instruction set is required to set temp, bias and vop
                self.fn | EXTENDED_INSTR,
                # set temperature coefficient
                temp,
                # set bias system (n=3 recommended mux rate 1:40/1:34)
                bias,
                # set contrast with operating voltage (0x00~0x7f)
                # 0x00 = 3.00V, 0x3f = 6.84V, 0x7f = 10.68V
                # starting at 3.06V, each bit increments voltage by 0.06V at room temperature
                SET_VOP | contrast,
                # revert to basic instruction set
                self.fn & ~EXTENDED_INSTR):
            self.cmd(cmd)

    def invert(self, invert):
        self.cmd(DISPLAY_INVERSE if invert else DISPLAY_NORMAL)

    def clear(self):
        # clear DDRAM, reset x,y position to 0,0
        self.data([0] * (HEIGHT * WIDTH // 8))
        self.position(0, 0)

    def addressing(self, horizontal=True):
        # vertical or horizontal addressing
        if horizontal:
            self.fn &= ~ADDRESSING_VERT
        else:
            self.fn |= ADDRESSING_VERT
        self.cmd(self.fn)

    def position(self, x, y):
        # set cursor to column x (0~83), bank y (0~5)
        self.cmd(COL_ADDR | x)  # set x pos (0~83)
        self.cmd(BANK_ADDR | y)  # set y pos (0~5)

    def cmd(self, command):
        self.dc(0)
        self.cs(0)
        self.spi.write(bytearray([command]))
        self.cs(1)

    def data(self, data):
        self.dc(1)
        self.cs(0)
        self.spi.write(pack('B' * len(data), *data))
        self.cs(1)

    def text(self, txt: str, x: int = 0, y: int = 0, clear_screen: bool = False):
        if clear_screen:
            self.clear()
        txt_byte_array = []
        for ch in txt:
            txt_byte_array.extend(FONT[(ord(ch) - FONT_CHAR_OFFSET)])
        self.position(x, y)
        self.data(bytearray(txt_byte_array))


class PCD8544_FRAMEBUF(PCD8544):
    def __init__(self, spi, cs, dc, rst=None):
        super().__init__(spi, cs, dc, rst)
        self.buf = bytearray((HEIGHT // 8) * WIDTH)
        self.fbuf = framebuf.FrameBuffer(self.buf, WIDTH, HEIGHT, framebuf.MONO_VLSB)

    def fill(self, col):
        self.fbuf.fill(col)

    def pixel(self, x, y, col):
        self.fbuf.pixel(x, y, col)

    def scroll(self, dx, dy):
        self.fbuf.scroll(dx, dy)

    # software scroll

    def text(self, string, x, y, col):
        self.fbuf.text(string, x, y, col)

    def line(self, x1, y1, x2, y2, col):
        self.fbuf.line(x1, y1, x2, y2, col)

    def hline(self, x, y, w, col):
        self.fbuf.hline(x, y, w, col)

    def vline(self, x, y, h, col):
        self.fbuf.vline(x, y, h, col)

    def rect(self, x, y, w, h, col):
        self.fbuf.rect(x, y, w, h, col)

    def fill_rect(self, x, y, w, h, col):
        self.fbuf.fill_rect(x, y, w, h, col)

    def show(self):
        self.data(self.buf)
